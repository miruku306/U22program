import React, { useEffect, useState } from 'react';
import { getFirestore, collection, getDocs } from 'firebase/firestore';
import { initializeApp } from 'firebase/app';

// Firebaseã®åˆæœŸè¨­å®šï¼ˆè‡ªåˆ†ã®è¨­å®šã«ç½®ãæ›ãˆã¦ãã ã•ã„ï¼‰
const firebaseConfig = {
  apiKey: 'YOUR_API_KEY',        // APIã‚­ãƒ¼
  authDomain: 'YOUR_AUTH_DOMAIN',// èªè¨¼ãƒ‰ãƒ¡ã‚¤ãƒ³
  projectId: 'YOUR_PROJECT_ID',  // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID
};
const app = initializeApp(firebaseConfig); // Firebaseã‚¢ãƒ—ãƒªåˆæœŸåŒ–
const db = getFirestore(app);               // Firestoreãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å–å¾—

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®çµ±è¨ˆæƒ…å ±ã®å‹å®šç¾©
type UserStats = {
  userId: string;        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
  userName: string;      // ãƒ¦ãƒ¼ã‚¶ãƒ¼å
  missedTasks: number;   // æœªé”æˆå›æ•°ï¼ˆã‚¿ã‚¹ã‚¯ã‚’é”æˆã§ããªã‹ã£ãŸå›æ•°ï¼‰
  bombedCount: number;   // è¢«çˆ†æ•°ï¼ˆçˆ†æ’ƒã‚’å—ã‘ãŸå›æ•°ï¼‰
};

const Ranking: React.FC = () => {
  // ã‚¹ãƒ†ãƒ¼ãƒˆï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼çµ±è¨ˆæƒ…å ±ã®ãƒªã‚¹ãƒˆ
  const [stats, setStats] = useState<UserStats[]>([]);
  // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã®ç®¡ç†
  const [loading, setLoading] = useState(true);
  // MVPï¼ˆæœ€å¤šè¢«çˆ†è€…ï¼‰ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±
  const [mvp, setMvp] = useState<UserStats | null>(null);

  // ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ãƒã‚¦ãƒ³ãƒˆæ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹å‰¯ä½œç”¨
  useEffect(() => {
    const fetchStats = async () => {
      setLoading(true); // ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­ã«ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã«ã™ã‚‹
      try {
        // Firestoreã®"userStats"ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰å…¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å–å¾—
        const querySnapshot = await getDocs(collection(db, 'userStats'));

        // å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’é…åˆ—ã«å¤‰æ›
        const data: UserStats[] = [];
        querySnapshot.forEach((doc) => {
          data.push(doc.data() as UserStats);
        });

        setStats(data); // ã‚¹ãƒ†ãƒ¼ãƒˆã«è¨­å®š

        // MVPï¼ˆæœ€å¤šè¢«çˆ†è€…ï¼‰ã‚’è¨ˆç®—ï¼šè¢«çˆ†æ•°ãŒæœ€å¤§ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸ã¶
        const maxBombed = data.reduce((prev, curr) => (curr.bombedCount > prev.bombedCount ? curr : prev), data[0]);
        setMvp(maxBombed); // MVPã‚’ã‚»ãƒƒãƒˆ
      } catch (error) {
        // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã«ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›
        console.error('Error fetching stats:', error);
      } finally {
        setLoading(false); // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çµ‚äº†
      }
    };
    fetchStats(); // ãƒ‡ãƒ¼ã‚¿å–å¾—é–¢æ•°ã‚’å‘¼ã³å‡ºã—
  }, []);

  // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸­ã¯èª­ã¿è¾¼ã¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
  if (loading) return <div>èª­ã¿è¾¼ã¿ä¸­...</div>;

  return (
    <div>
      <h1>ğŸ† ã‚µãƒœã‚Šå¯è¦–åŒ–ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h1>

      {/* ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®ãƒ†ãƒ¼ãƒ–ãƒ« */}
      <table
        border={1}
        cellPadding={8}
        style={{ borderCollapse: 'collapse', width: '100%', maxWidth: 600 }}
      >
        <thead>
          <tr>
            <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼å</th>
            <th>æœªé”æˆå›æ•°</th>
            <th>è¢«çˆ†æ•°</th>
          </tr>
        </thead>

        <tbody>
          {/* è¢«çˆ†æ•°ã§é™é †ã«ä¸¦ã¹æ›¿ãˆã€ãƒ†ãƒ¼ãƒ–ãƒ«ã®è¡Œã‚’ç”Ÿæˆ */}
          {stats
            .sort((a, b) => b.bombedCount - a.bombedCount)
            .map(({ userId, userName, missedTasks, bombedCount }) => (
              // MVPã®è¡Œã¯èƒŒæ™¯è‰²ã‚’ã‚´ãƒ¼ãƒ«ãƒ‰ã«å¤‰æ›´ã—ã¦å¼·èª¿è¡¨ç¤º
              <tr key={userId} style={{ backgroundColor: mvp?.userId === userId ? '#ffd700' : 'transparent' }}>
                <td>{userName}</td>
                <td>{missedTasks}</td>
                <td>{bombedCount}</td>
              </tr>
            ))}
        </tbody>
      </table>

      {/* MVPè¡¨ç¤ºï¼šæœ€å¤šè¢«çˆ†è€…ã®åå‰ã¨è¢«çˆ†æ•° */}
      {mvp && (
        <div style={{ marginTop: 20, padding: 10, backgroundColor: '#fff8dc', border: '1px solid #ccc' }}>
          <strong>MVPï¼ˆæœ€å¤šè¢«çˆ†è€…ï¼‰:</strong> {mvp.userName} ã•ã‚“ï¼ˆ{mvp.bombedCount}å›ï¼‰
        </div>
      )}
    </div>
  );
};

export default Ranking;
