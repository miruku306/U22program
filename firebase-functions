const functions = require("firebase-functions");
const admin = require("firebase-admin");
const axios = require("axios");
const { characterAssets } = require("./characterAssets");

admin.initializeApp();

exports.sendCharacterImageNotification = functions.pubsub.schedule("every 1 hours").onRun(async () => {
  const usersRef = admin.firestore().collection("users");
  const snapshot = await usersRef.where("optIn", "==", true).get();

  for (const doc of snapshot.docs) {
    const user = doc.data();
    const persona = user.persona || "military";
    const task = "明日のプレゼン準備";

    const character = characterAssets[persona];

    if (!character) continue;

    const messages = [
      {
        type: "text",
        text: character.text(task),
      },
      {
        type: "image",
        originalContentUrl: character.imageUrl,
        previewImageUrl: character.imageUrl,
      },
    ];

    try {
      await axios.post("https://api.line.me/v2/bot/message/push", {
        to: user.lineUserId,
        messages,
      }, {
        headers: {
          "Authorization": `Bearer ${process.env.LINE_ACCESS_TOKEN}`,
          "Content-Type": "application/json"
        }
      });
    } catch (err) {
      console.error("LINE送信失敗", err.message);
    }
  }
});
